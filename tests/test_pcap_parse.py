#!/usr/bin/env python3

# run only one test:
# python -m unittest test_netfoot.Netfoot_log_unittest.test_infos_lookup

import sys
import unittest
from pathlib import Path

sys.path.append(str(Path(__file__).resolve().parent.parent / 'lib'))
from pcap_parse import Pcap_parse

INPUT_DATA_DIRECTORY = Path(__file__).resolve().parent.parent / 'demo_data'

EXPECTED_RESULTS = {
    'network2_with_pcap/host_192.168.3.131_pcap_enp0s31f6.pcap': {
        ('192.168.3.131', 57011, '72.14.213.138', 80, 'tcp'): {'packets': 9, 'bytes': 4533, 'first_packet': 1}, ('192.168.3.131', 55950, '72.14.213.102', 80, 'tcp'): {'packets': 9, 'bytes': 1815, 'first_packet': 3}, ('192.168.3.131', 52152, '72.14.213.147', 443, 'tcp'): {'packets': 82, 'bytes': 34986, 'first_packet': 13}, ('192.168.3.131', 55953, '65.55.206.209', 80, 'tcp'): {'packets': 6, 'bytes': 1013, 'first_packet': 26}, ('192.168.3.131', 55954, '65.55.17.37', 80, 'tcp'): {'packets': 32, 'bytes': 27603, 'first_packet': 69}, ('192.168.3.131', 55955, '207.46.148.38', 80, 'tcp'): {'packets': 8, 'bytes': 1067, 'first_packet': 99}, ('192.168.3.131', 55956, '66.235.139.121', 80, 'tcp'): {'packets': 13, 'bytes': 5867, 'first_packet': 110}, ('192.168.3.131', 55957, '65.55.5.232', 80, 'tcp'): {'packets': 21, 'bytes': 13043, 'first_packet': 114}, ('192.168.3.131', 55958, '65.55.239.163', 80, 'tcp'): {'packets': 12, 'bytes': 4073, 'first_packet': 115}, ('192.168.3.131', 55959, '65.55.5.231', 80, 'tcp'): {'packets': 18, 'bytes': 10089, 'first_packet': 133}, ('192.168.3.131', 55960, '206.108.207.139', 80, 'tcp'): {'packets': 16, 'bytes': 4228, 'first_packet': 141}, ('192.168.3.131', 55961, '184.24.133.32', 80, 'tcp'): {'packets': 7, 'bytes': 1530, 'first_packet': 142}, ('192.168.3.131', 55962, '65.55.5.232', 80, 'tcp'): {'packets': 12, 'bytes': 6905, 'first_packet': 154}, ('192.168.3.131', 55963, '65.54.95.140', 80, 'tcp'): {'packets': 25, 'bytes': 14796, 'first_packet': 162}, ('192.168.3.131', 55966, '63.215.202.48', 80, 'tcp'): {'packets': 6, 'bytes': 1395, 'first_packet': 173}, ('192.168.3.131', 55967, '63.215.202.49', 80, 'tcp'): {'packets': 8, 'bytes': 5178, 'first_packet': 182}, ('192.168.3.131', 55968, '72.14.213.101', 80, 'tcp'): {'packets': 11, 'bytes': 2728, 'first_packet': 195}, ('192.168.3.131', 55971, '65.55.17.37', 80, 'tcp'): {'packets': 8, 'bytes': 2832, 'first_packet': 202}, ('192.168.3.131', 57839, '72.14.213.147', 80, 'tcp'): {'packets': 40, 'bytes': 28761, 'first_packet': 205}, ('192.168.3.131', 55972, '207.46.216.54', 80, 'tcp'): {'packets': 12, 'bytes': 2838, 'first_packet': 222}, ('192.168.3.131', 55973, '65.54.95.142', 80, 'tcp'): {'packets': 42, 'bytes': 35296, 'first_packet': 223}, ('192.168.3.131', 58264, '208.82.236.129', 80, 'tcp'): {'packets': 9, 'bytes': 1153, 'first_packet': 290}, ('192.168.3.131', 58265, '208.82.236.129', 80, 'tcp'): {'packets': 14, 'bytes': 7838, 'first_packet': 308}, ('72.14.213.105', 443, '192.168.3.131', 57721, 'tcp'): {'packets': 6, 'bytes': 338, 'first_packet': 325}, ('192.168.3.131', 58272, '208.82.236.129', 80, 'tcp'): {'packets': 15, 'bytes': 7772, 'first_packet': 331}, ('72.14.213.18', 443, '192.168.3.131', 49673, 'tcp'): {'packets': 30, 'bytes': 3112, 'first_packet': 348}, ('192.168.3.131', 57757, '239.255.255.250', 1900, 'udp'): {'packets': 6, 'bytes': 912, 'first_packet': 380}, ('192.168.3.131', 57038, '74.217.50.10', 80, 'tcp'): {'packets': 3, 'bytes': 120, 'first_packet': 387}, ('192.168.3.131', 52201, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 394}, ('192.168.3.131', 52202, '72.14.213.102', 443, 'tcp'): {'packets': 125, 'bytes': 75078, 'first_packet': 395}, ('192.168.3.131', 52203, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 396}, ('192.168.3.131', 52204, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 397}, ('192.168.3.131', 52205, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 398}, ('192.168.3.131', 52206, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 399}, ('192.168.3.131', 52207, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 2689, 'first_packet': 443}, ('192.168.3.131', 52208, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 445}, ('192.168.3.131', 52209, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 449}, ('192.168.3.131', 52210, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 451}, ('192.168.3.131', 52211, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 453}, ('192.168.3.131', 52212, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 526}, ('192.168.3.131', 52213, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 546}, ('192.168.3.131', 52214, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 548}, ('192.168.3.131', 52215, '72.14.213.102', 443, 'tcp'): {'packets': 11, 'bytes': 1139, 'first_packet': 554}, ('192.168.3.131', 58303, '208.82.236.129', 80, 'tcp'): {'packets': 9, 'bytes': 1154, 'first_packet': 693}, ('192.168.3.131', 58304, '208.82.236.129', 80, 'tcp'): {'packets': 14, 'bytes': 7914, 'first_packet': 701}, ('192.168.3.131', 58305, '208.82.236.129', 80, 'tcp'): {'packets': 10, 'bytes': 2281, 'first_packet': 717}, ('192.168.3.131', 56012, '65.54.95.140', 80, 'tcp'): {'packets': 48, 'bytes': 41666, 'first_packet': 718}, ('192.168.3.131', 58310, '208.82.236.129', 80, 'tcp'): {'packets': 16, 'bytes': 9661, 'first_packet': 774}, ('192.168.3.131', 56021, '66.235.139.121', 80, 'tcp'): {'packets': 15, 'bytes': 4482, 'first_packet': 792}, ('192.168.3.131', 56022, '65.55.206.199', 80, 'tcp'): {'packets': 82, 'bytes': 79652, 'first_packet': 799}, ('192.168.3.131', 56023, '184.24.143.139', 80, 'tcp'): {'packets': 7, 'bytes': 1064, 'first_packet': 818}, ('192.168.3.131', 56026, '65.54.95.140', 80, 'tcp'): {'packets': 17, 'bytes': 8751, 'first_packet': 829}, ('192.168.3.131', 56027, '65.54.95.140', 80, 'tcp'): {'packets': 20, 'bytes': 9589, 'first_packet': 830}, ('192.168.3.131', 56028, '65.54.95.142', 80, 'tcp'): {'packets': 14, 'bytes': 6298, 'first_packet': 842}, ('192.168.3.131', 56029, '65.54.95.142', 80, 'tcp'): {'packets': 18, 'bytes': 8856, 'first_packet': 843}, ('192.168.3.131', 56030, '65.54.95.140', 80, 'tcp'): {'packets': 10, 'bytes': 2033, 'first_packet': 865}, ('192.168.3.131', 56031, '65.54.95.140', 80, 'tcp'): {'packets': 10, 'bytes': 2479, 'first_packet': 866}, ('192.168.3.131', 56032, '65.54.95.140', 80, 'tcp'): {'packets': 10, 'bytes': 1969, 'first_packet': 867}, ('192.168.3.131', 56033, '65.54.95.140', 80, 'tcp'): {'packets': 10, 'bytes': 1976, 'first_packet': 868}, ('192.168.3.131', 56034, '65.55.206.199', 80, 'tcp'): {'packets': 20, 'bytes': 14270, 'first_packet': 888}, ('192.168.3.131', 56035, '65.55.118.107', 80, 'tcp'): {'packets': 10, 'bytes': 2668, 'first_packet': 893}, ('192.168.3.131', 56036, '65.54.95.140', 80, 'tcp'): {'packets': 60, 'bytes': 49689, 'first_packet': 894}, ('192.168.3.131', 56037, '65.54.95.140', 80, 'tcp'): {'packets': 54, 'bytes': 44883, 'first_packet': 895}, ('192.168.3.131', 56038, '65.54.95.140', 80, 'tcp'): {'packets': 28, 'bytes': 17164, 'first_packet': 896}, ('192.168.3.131', 56039, '65.54.95.140', 80, 'tcp'): {'packets': 32, 'bytes': 21361, 'first_packet': 897}, ('192.168.3.131', 56040, '65.54.95.140', 80, 'tcp'): {'packets': 29, 'bytes': 19284, 'first_packet': 898}, ('192.168.3.131', 56041, '65.54.95.140', 80, 'tcp'): {'packets': 37, 'bytes': 26504, 'first_packet': 899}, ('192.168.3.131', 56042, '207.46.148.38', 80, 'tcp'): {'packets': 8, 'bytes': 1551, 'first_packet': 1028}, ('192.168.3.131', 56044, '65.54.95.216', 80, 'tcp'): {'packets': 30, 'bytes': 19867, 'first_packet': 1073}, ('192.168.3.131', 56048, '66.220.149.32', 80, 'tcp'): {'packets': 24, 'bytes': 13613, 'first_packet': 1190}, ('192.168.3.131', 56049, '206.108.207.163', 80, 'tcp'): {'packets': 8, 'bytes': 2635, 'first_packet': 1195}, ('192.168.3.131', 56050, '66.235.139.121', 80, 'tcp'): {'packets': 4, 'bytes': 184, 'first_packet': 1207}, ('192.168.3.131', 56051, '207.46.0.109', 80, 'tcp'): {'packets': 31, 'bytes': 19668, 'first_packet': 1209}, ('192.168.3.131', 56052, '207.46.148.38', 80, 'tcp'): {'packets': 9, 'bytes': 2884, 'first_packet': 1213}, ('192.168.3.131', 56053, '66.235.133.62', 80, 'tcp'): {'packets': 11, 'bytes': 3176, 'first_packet': 1214}, ('192.168.3.131', 56054, '206.108.207.145', 80, 'tcp'): {'packets': 13, 'bytes': 3271, 'first_packet': 1220}, ('192.168.3.131', 56055, '65.54.95.39', 80, 'tcp'): {'packets': 30, 'bytes': 14000, 'first_packet': 1249}, ('192.168.3.131', 56056, '65.54.95.39', 80, 'tcp'): {'packets': 22, 'bytes': 7309, 'first_packet': 1250}, ('192.168.3.131', 56057, '65.54.95.66', 80, 'tcp'): {'packets': 19, 'bytes': 8552, 'first_packet': 1276}, ('192.168.3.131', 56058, '206.108.207.138', 80, 'tcp'): {'packets': 89, 'bytes': 88512, 'first_packet': 1292}, ('192.168.3.131', 56059, '65.54.95.39', 80, 'tcp'): {'packets': 25, 'bytes': 9843, 'first_packet': 1373}, ('192.168.3.131', 56060, '65.54.95.39', 80, 'tcp'): {'packets': 14, 'bytes': 8028, 'first_packet': 1377}, ('192.168.3.131', 56061, '195.27.155.11', 80, 'tcp'): {'packets': 10, 'bytes': 2727, 'first_packet': 1396}, ('192.168.3.131', 56064, '65.54.95.75', 80, 'tcp'): {'packets': 169, 'bytes': 167103, 'first_packet': 1411}, ('192.168.3.131', 56065, '65.54.95.68', 80, 'tcp'): {'packets': 177, 'bytes': 181009, 'first_packet': 1553}, ('192.168.3.131', 56066, '65.54.95.75', 80, 'tcp'): {'packets': 31, 'bytes': 23135, 'first_packet': 1617}, ('192.168.3.131', 56067, '65.54.95.75', 80, 'tcp'): {'packets': 88, 'bytes': 71168, 'first_packet': 1768}, ('192.168.3.131', 56068, '65.54.95.68', 80, 'tcp'): {'packets': 42, 'bytes': 30340, 'first_packet': 1787}, ('192.168.3.131', 56069, '65.54.95.75', 80, 'tcp'): {'packets': 38, 'bytes': 28906, 'first_packet': 1797}, ('192.168.3.131', 56070, '65.54.95.68', 80, 'tcp'): {'packets': 44, 'bytes': 37208, 'first_packet': 1828}, ('192.168.3.131', 68, '255.255.255.255', 67, 'udp'): {'packets': 1, 'bytes': 328, 'first_packet': 1888}, ('192.168.3.131', 54600, '224.0.0.252', 5355, 'udp'): {'packets': 2, 'bytes': 100, 'first_packet': 1889}, ('192.168.3.131', 56073, '65.54.95.75', 80, 'tcp'): {'packets': 49, 'bytes': 35665, 'first_packet': 1899}, ('192.168.3.131', 58327, '208.82.236.129', 80, 'tcp'): {'packets': 15, 'bytes': 7222, 'first_packet': 1944}, ('192.168.3.131', 52248, '65.54.95.39', 80, 'tcp'): {'packets': 11, 'bytes': 935, 'first_packet': 2107}, ('192.168.3.131', 56090, '65.54.95.75', 80, 'tcp'): {'packets': 15, 'bytes': 4666, 'first_packet': 2130}, ('192.168.3.131', 56091, '65.54.95.75', 80, 'tcp'): {'packets': 16, 'bytes': 6819, 'first_packet': 2131}, ('192.168.3.131', 56092, '65.54.95.68', 80, 'tcp'): {'packets': 15, 'bytes': 6262, 'first_packet': 2133}, ('192.168.3.131', 56093, '65.54.95.68', 80, 'tcp'): {'packets': 37, 'bytes': 29682, 'first_packet': 2135}, ('192.168.3.131', 52257, '65.54.95.39', 80, 'tcp'): {'packets': 11, 'bytes': 901, 'first_packet': 2203}, ('192.168.3.131', 58350, '208.82.236.129', 80, 'tcp'): {'packets': 10, 'bytes': 3419, 'first_packet': 2259}, ('192.168.3.131', 58351, '208.82.236.130', 80, 'tcp'): {'packets': 17, 'bytes': 10313, 'first_packet': 2269}, ('192.168.3.131', 58352, '208.82.236.130', 80, 'tcp'): {'packets': 14, 'bytes': 6945, 'first_packet': 2270}, ('192.168.3.131', 58353, '208.82.236.130', 80, 'tcp'): {'packets': 17, 'bytes': 10863, 'first_packet': 2271}, ('192.168.3.131', 52266, '65.54.95.39', 80, 'tcp'): {'packets': 11, 'bytes': 935, 'first_packet': 2331}, ('192.168.3.131', 58360, '208.82.236.129', 80, 'tcp'): {'packets': 10, 'bytes': 3469, 'first_packet': 2339}, ('192.168.3.131', 58361, '208.82.236.130', 80, 'tcp'): {'packets': 16, 'bytes': 9929, 'first_packet': 2340}, ('192.168.3.131', 58362, '208.82.238.129', 80, 'tcp'): {'packets': 3, 'bytes': 144, 'first_packet': 2341}, ('192.168.3.131', 56110, '65.54.95.68', 80, 'tcp'): {'packets': 42, 'bytes': 36214, 'first_packet': 2353}, ('192.168.3.131', 56111, '65.54.95.75', 80, 'tcp'): {'packets': 12, 'bytes': 4978, 'first_packet': 2354}, ('192.168.3.131', 56112, '65.54.95.68', 80, 'tcp'): {'packets': 13, 'bytes': 6490, 'first_packet': 2356}, ('192.168.3.131', 56113, '65.54.95.75', 80, 'tcp'): {'packets': 13, 'bytes': 6673, 'first_packet': 2357}, ('192.168.3.131', 58377, '208.82.236.130', 80, 'tcp'): {'packets': 15, 'bytes': 9395, 'first_packet': 2461}, ('192.168.3.131', 58378, '208.82.236.130', 80, 'tcp'): {'packets': 16, 'bytes': 9855, 'first_packet': 2462}, ('192.168.3.131', 56126, '66.235.139.121', 80, 'tcp'): {'packets': 11, 'bytes': 2500, 'first_packet': 2489}, ('192.168.3.131', 58381, '204.9.163.166', 80, 'tcp'): {'packets': 7, 'bytes': 821, 'first_packet': 2527}, ('192.168.3.131', 56127, '65.54.95.140', 80, 'tcp'): {'packets': 7, 'bytes': 2666, 'first_packet': 2532}, ('192.168.3.131', 56128, '65.54.95.140', 80, 'tcp'): {'packets': 11, 'bytes': 6586, 'first_packet': 2535}, ('192.168.3.131', 56129, '207.46.148.38', 80, 'tcp'): {'packets': 9, 'bytes': 3439, 'first_packet': 2553}, ('192.168.3.131', 56132, '65.54.95.140', 80, 'tcp'): {'packets': 42, 'bytes': 39799, 'first_packet': 2577}, ('192.168.3.131', 56133, '65.54.95.216', 80, 'tcp'): {'packets': 47, 'bytes': 43066, 'first_packet': 2606}, ('192.168.3.131', 56134, '66.235.133.62', 80, 'tcp'): {'packets': 6, 'bytes': 1003, 'first_packet': 2677}, ('192.168.3.131', 56135, '207.46.148.38', 80, 'tcp'): {'packets': 9, 'bytes': 2891, 'first_packet': 2691}, ('192.168.3.131', 56136, '206.108.207.163', 80, 'tcp'): {'packets': 3, 'bytes': 144, 'first_packet': 2716}, ('192.168.3.131', 56139, '65.54.95.75', 80, 'tcp'): {'packets': 129, 'bytes': 130085, 'first_packet': 2807}, ('192.168.3.131', 56140, '65.54.95.68', 80, 'tcp'): {'packets': 63, 'bytes': 59871, 'first_packet': 2938}
    }
}

class Pcap_parse_unittest(unittest.TestCase):
    def test_network2_with_pcap(self):
        self.maxDiff = None
        pcapfile = "network2_with_pcap/host_192.168.3.131_pcap_enp0s31f6.pcap"
        parsed = Pcap_parse.parse(INPUT_DATA_DIRECTORY / pcapfile)
        self.assertEqual(EXPECTED_RESULTS[pcapfile], parsed)

if __name__ == "__main__":
    unittest.main()
